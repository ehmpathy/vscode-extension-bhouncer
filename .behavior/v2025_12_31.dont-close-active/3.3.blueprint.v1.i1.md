# blueprint: dont-close-active

## summary

implement per-extension closure policies and keystroke-based activity tracking to prevent closing actively-used editors while still managing workspace tidiness.

---

## changes required

### 1. domain.objects/BouncePolicy.ts (new)

define the bounce policy enum:

```ts
/**
 * .what = policy for when to close an editor tab
 * .why = enables per-extension control over idle vs tabs-limit closure
 */
export type BouncePolicy = 'IDLE_LIMIT' | 'TABS_LIMIT' | 'BOTH';
```

---

### 2. package.json configuration schema

add new setting `bhouncer.editors.bounceOnByExtension`:

```json
"bhouncer.editors.bounceOnByExtension": {
  "type": "object",
  "default": {
    ".md": "TABS_LIMIT",
    ".markdown": "TABS_LIMIT"
  },
  "description": "Per-extension closure policy: IDLE_LIMIT (close on timeout), TABS_LIMIT (close on LRU overflow), BOTH (either)"
}
```

---

### 3. contract/extension.ts modifications

#### 3.1 add document change listener for keystroke tracking

register `vscode.workspace.onDidChangeTextDocument` to reset idle timer:

```ts
// track editor activity on document changes (keystrokes)
vsContext.subscriptions.push(
  vscode.workspace.onDidChangeTextDocument((event) => {
    // only track user-initiated changes (not external/terminal edits)
    if (event.contentChanges.length > 0) {
      state.editorLastAccess.set(event.document.uri.toString(), Date.now());
    }
  }),
);
```

this ensures typing resets the idle timer, fulfilling usecase.1.

---

### 4. domain.operations/editors/getExtension.ts (new)

```ts
/**
 * .what = extracts file extension from uri string
 * .why = enables extension-based policy lookup
 */
export const getExtension = (input: { uri: string }): string => {
  const path = input.uri.split('?')[0]; // strip query params
  const lastDot = path.lastIndexOf('.');
  if (lastDot === -1) return '';
  return path.slice(lastDot).toLowerCase();
};
```

---

### 5. domain.operations/editors/getDefaultBounceConfig.ts (new)

```ts
import type { BouncePolicy } from '../../domain.objects/BouncePolicy';

/**
 * .what = returns the default bounceOnByExtension config
 * .why = centralizes default policy for .md files (TABS_LIMIT only)
 */
export const getDefaultBounceConfig = (): Record<string, BouncePolicy> => ({
  '.md': 'TABS_LIMIT',
  '.markdown': 'TABS_LIMIT',
});
```

---

### 6. domain.operations/editors/getBouncePolicy.ts (new)

```ts
import type { BouncePolicy } from '../../domain.objects/BouncePolicy';
import { getExtension } from './getExtension';

/**
 * .what = resolves bounce policy for a file based on extension
 * .why = enables per-extension closure rules with sensible defaults
 */
export const getBouncePolicy = (input: {
  uri: string;
  config: Record<string, BouncePolicy>;
}): BouncePolicy => {
  // extract extension from uri
  const ext = getExtension({ uri: input.uri });

  // return configured policy or default to BOTH
  return input.config[ext] ?? 'BOTH';
};
```

---

### 7. domain.operations/editors/selectTabsToClose.ts modifications

update signature to accept bounce policies:

```ts
import type { BouncePolicy } from '../../domain.objects/BouncePolicy';
import { getBouncePolicy } from './getBouncePolicy';

export const selectTabsToClose = (input: {
  tabs: EditorTabInfo[];
  maxOpen: number;
  idleTimeoutMs: number;
  now: number;
  bounceOnByExtension: Record<string, BouncePolicy>; // new
}): vscode.Tab[] => {
  const tabsToClose: vscode.Tab[] = [];

  input.tabs.forEach((item, index) => {
    const policy = getBouncePolicy({
      uri: item.uri,
      config: input.bounceOnByExtension,
    });

    const isOverLimit = index >= input.maxOpen;
    const isIdle =
      item.lastAccess > 0 &&
      input.now - item.lastAccess > input.idleTimeoutMs;

    // apply policy-aware closure logic
    const shouldClose = (() => {
      if (policy === 'IDLE_LIMIT') return isIdle;
      if (policy === 'TABS_LIMIT') return isOverLimit;
      return isOverLimit || isIdle; // BOTH
    })();

    if (shouldClose) {
      tabsToClose.push(item.tab);
    }
  });

  return tabsToClose;
};
```

---

### 8. domain.operations/editors/pruneEditors.ts modifications

read new config and pass to selectTabsToClose:

```ts
import type { BouncePolicy } from '../../domain.objects/BouncePolicy';
import { getDefaultBounceConfig } from './getDefaultBounceConfig';

// ... inside pruneEditors:

const bounceOnByExtension = config.get<Record<string, BouncePolicy>>(
  'editors.bounceOnByExtension',
  getDefaultBounceConfig(),
);

const tabsToClose = selectTabsToClose({
  tabs,
  maxOpen,
  idleTimeoutMs,
  now,
  bounceOnByExtension, // new
});
```

---

## files to create

| path | purpose |
|------|---------|
| `src/domain.objects/BouncePolicy.ts` | bounce policy type definition |
| `src/domain.operations/editors/getExtension.ts` | uri extension extractor |
| `src/domain.operations/editors/getExtension.test.ts` | unit tests for getExtension |
| `src/domain.operations/editors/getDefaultBounceConfig.ts` | default config factory |
| `src/domain.operations/editors/getDefaultBounceConfig.test.ts` | unit tests for defaults |
| `src/domain.operations/editors/getBouncePolicy.ts` | policy resolver per extension |
| `src/domain.operations/editors/getBouncePolicy.test.ts` | unit tests for getBouncePolicy |

## files to modify

| path | changes |
|------|---------|
| `package.json` | add `bounceOnByExtension` configuration |
| `src/contract/extension.ts` | add `onDidChangeTextDocument` listener |
| `src/contract/extension.test.ts` | add tests for keystroke tracking |
| `src/domain.operations/editors/selectTabsToClose.ts` | policy-aware closure logic |
| `src/domain.operations/editors/selectTabsToClose.test.ts` | update for policy-aware logic |
| `src/domain.operations/editors/pruneEditors.ts` | read and pass bounceOnByExtension config |
| `src/domain.operations/editors/pruneEditors.test.ts` | update for config passing |

---

## test coverage matrix

| file | test file | coverage |
|------|-----------|----------|
| `getExtension.ts` | `getExtension.test.ts` | extension extraction: normal, query params, no ext, multiple dots, uppercase |
| `BouncePolicy.ts` | (type-only) | verified by tsc |
| `getDefaultBounceConfig.ts` | `getDefaultBounceConfig.test.ts` | returns correct default config |
| `getBouncePolicy.ts` | `getBouncePolicy.test.ts` | config match, fallback to BOTH, no extension |
| `selectTabsToClose.ts` | `selectTabsToClose.test.ts` | IDLE_LIMIT, TABS_LIMIT, BOTH policies; backwards compat |
| `pruneEditors.ts` | `pruneEditors.test.ts` | config reading; .md idle but under limit stays open |
| `extension.ts` | `extension.test.ts` | onDidChangeTextDocument updates lastAccess; empty changes ignored |

---

## implementation order

1. **getExtension.ts + test** - utility, no dependencies
2. **BouncePolicy.ts** - type definition, no dependencies
3. **getDefaultBounceConfig.ts + test** - depends on BouncePolicy
4. **getBouncePolicy.ts + test** - depends on getExtension + BouncePolicy
5. **package.json** - add configuration schema
6. **selectTabsToClose.ts + test** - update to accept and apply policies
7. **pruneEditors.ts + test** - read config, pass to selectTabsToClose
8. **extension.ts + test** - add onDidChangeTextDocument listener

---

## verification

all blackbox criteria verified via automated tests:

| criteria | test location |
|----------|---------------|
| typing resets idle timer | `extension.test.ts` |
| .md files only close on tabs limit | `selectTabsToClose.test.ts` |
| .ts files close on idle OR tabs limit | `selectTabsToClose.test.ts` |
| user can override via config | `getBouncePolicy.test.ts` |
| default config is correct | `getDefaultBounceConfig.test.ts` |
| no-extension files use BOTH | `getBouncePolicy.test.ts` |
