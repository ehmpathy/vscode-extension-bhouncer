# roadmap: dont-close-active

## execution checklist

---

### step.1: create getExtension utility

**depends on:** nothing (leaf node)

**files:**
- [ ] create `src/domain.operations/editors/getExtension.ts`
- [ ] create `src/domain.operations/editors/getExtension.test.ts`

**acceptance criteria:**
```
given('a uri string')
  when('uri has extension like "file:///path/to/file.ts"')
    then('returns ".ts"')
  when('uri has extension with query params like "file:///path/to/file.md?query=1"')
    then('returns ".md"')
  when('uri has no extension like "file:///path/to/Makefile"')
    then('returns ""')
  when('uri has multiple dots like "file:///path/to/file.test.ts"')
    then('returns ".ts" (last extension)')
  when('uri has uppercase extension like "file:///path/to/README.MD"')
    then('returns ".md" (lowercase)')
```

**verification:**
```sh
npm run test:unit -- getExtension.test.ts
```

---

### step.2: create BouncePolicy type

**depends on:** nothing (leaf node)

**files:**
- [ ] create `src/domain.objects/BouncePolicy.ts`

**acceptance criteria:**
```
given('BouncePolicy type is defined')
  when('imported')
    then('type allows "IDLE_LIMIT" | "TABS_LIMIT" | "BOTH"')
    then('type does NOT allow other string values')
```

**verification:**
```sh
npm run test:types
```

---

### step.3: create getBouncePolicy operation

**depends on:** step.1 (getExtension), step.2 (BouncePolicy)

**files:**
- [ ] create `src/domain.operations/editors/getBouncePolicy.ts`
- [ ] create `src/domain.operations/editors/getBouncePolicy.test.ts`

**acceptance criteria:**
```
given('a uri and config map')
  when('extension matches a config key')
    then('returns the configured policy')
  when('extension does NOT match any config key')
    then('returns "BOTH" as default')

given('config has ".md": "TABS_LIMIT"')
  when('uri is "file:///docs/readme.md"')
    then('returns "TABS_LIMIT"')

given('config has ".ts": "IDLE_LIMIT"')
  when('uri is "file:///src/index.ts"')
    then('returns "IDLE_LIMIT"')

given('config is empty {}')
  when('uri is "file:///src/index.ts"')
    then('returns "BOTH"')

given('uri has no extension')
  when('config has no empty-string key')
    then('returns "BOTH"')
```

**verification:**
```sh
npm run test:unit -- getBouncePolicy.test.ts
```

---

### step.4: add bounceOnByExtension config to package.json

**depends on:** step.2 (BouncePolicy type exists for documentation)

**files:**
- [ ] modify `package.json` contributes.configuration.properties
- [ ] create `src/domain.operations/editors/getDefaultBounceConfig.ts`
- [ ] create `src/domain.operations/editors/getDefaultBounceConfig.test.ts`

**acceptance criteria:**
```
given('package.json configuration schema')
  when('bhouncer.editors.bounceOnByExtension is declared')
    then('type is "object"')
    then('default is { ".md": "TABS_LIMIT", ".markdown": "TABS_LIMIT" }')
    then('description explains IDLE_LIMIT, TABS_LIMIT, BOTH options')

given('getDefaultBounceConfig is called')
  when('no arguments')
    then('returns { ".md": "TABS_LIMIT", ".markdown": "TABS_LIMIT" }')
```

**verification:**
```sh
npm run test:unit -- getDefaultBounceConfig.test.ts
npm run build
```

---

### step.5: update selectTabsToClose with policy-aware logic

**depends on:** step.3 (getBouncePolicy)

**files:**
- [ ] modify `src/domain.operations/editors/selectTabsToClose.ts`
- [ ] update `src/domain.operations/editors/selectTabsToClose.test.ts`

**acceptance criteria:**
```
given('tabs with mixed extensions and bounceOnByExtension config')
  when('policy is IDLE_LIMIT for .md')
    then('.md tabs close ONLY when idle timeout exceeded')
    then('.md tabs do NOT close when over tabs limit but not idle')

  when('policy is TABS_LIMIT for .md')
    then('.md tabs close ONLY when over tabs limit')
    then('.md tabs do NOT close when idle but under tabs limit')

  when('policy is BOTH for .ts')
    then('.ts tabs close when idle OR over limit')

given('backwards compatibility')
  when('bounceOnByExtension is empty {}')
    then('all tabs use BOTH policy (existing behavior)')
```

**verification:**
```sh
npm run test:unit -- selectTabsToClose.test.ts
```

---

### step.6: update pruneEditors to read and pass config

**depends on:** step.4 (config exists), step.5 (selectTabsToClose accepts config)

**files:**
- [ ] modify `src/domain.operations/editors/pruneEditors.ts`
- [ ] update `src/domain.operations/editors/pruneEditors.test.ts`

**acceptance criteria:**
```
given('pruneEditors is called')
  when('bhouncer.editors.bounceOnByExtension config exists')
    then('config is read from vscode.workspace.getConfiguration')
    then('config is passed to selectTabsToClose')

given('default config { ".md": "TABS_LIMIT", ".markdown": "TABS_LIMIT" }')
  when('.md file is idle but under tabs limit')
    then('.md file is NOT closed')
  when('.md file is LRU and over tabs limit')
    then('.md file IS closed')
```

**verification:**
```sh
npm run test:unit -- pruneEditors.test.ts
```

---

### step.7: add keystroke tracking via onDidChangeTextDocument

**depends on:** nothing (parallel to steps 1-6)

**files:**
- [ ] modify `src/contract/extension.ts`
- [ ] update `src/contract/extension.test.ts`

**acceptance criteria:**
```
given('user types in an editor')
  when('onDidChangeTextDocument fires with contentChanges.length > 0')
    then('editorLastAccess is updated to Date.now() for that document uri')

given('external process modifies a file')
  when('onDidChangeTextDocument fires with contentChanges.length === 0')
    then('editorLastAccess is NOT updated')
    sothat('only user keystrokes reset idle timer')

given('user types continuously')
  when('idle timeout would have elapsed without typing')
    then('editor does NOT close because lastAccess keeps updating')
```

**verification:**
```sh
npm run test:unit -- extension.test.ts
```

---

### step.8: full test suite verification

**depends on:** steps 1-7 complete

**files:**
- [ ] all unit tests pass
- [ ] type checks pass
- [ ] build succeeds

**acceptance criteria (from blackbox):**

```
# usecase.1 - keystroke tracking
given('a user typing in an editor')
  when('the user has been typing within the idle timeout window')
    then('the editor does NOT close due to idle timeout')
    then('the idle timer resets on each keystroke')

# usecase.2 - per-extension policy
given('a user configures bounceOn policy per file extension')
  when('policy is set to TABS_LIMIT for an extension')
    then('editors with that extension do NOT close due to idle timeout')

# usecase.3 - markdown defaults
given('a .md file is open')
  when('no explicit bounceOn policy is configured for .md')
    then('the default policy for .md is TABS_LIMIT')
  when('the idle timeout elapses but tabs limit is not exceeded')
    then('the .md editor remains open')

# usecase.4 - typescript defaults
given('a .ts file is open')
  when('no explicit bounceOn policy is configured for .ts')
    then('the default policy for .ts is BOTH')
  when('the idle timeout elapses')
    then('the .ts editor is eligible for closure')

# boundary.1 - keystroke tracking scope
given('a user types in vscode editor')
  when('the document changes event fires')
    then('the idle timer resets for that editor')

# boundary.2 - policy configuration shape
given('a user configures bhouncer.editors.bounceOnByExtension')
  when('configuration is { ".md": "TABS_LIMIT", ".ts": "BOTH" }')
    then('.md files use TABS_LIMIT policy')
    then('.ts files use BOTH policy')
    then('unconfigured extensions use default BOTH')

# boundary.3 - edge case - new unsaved files
given('a new unsaved file (no extension yet)')
  when('the file has no extension')
    then('the default policy (BOTH) applies')
```

**verification:**
```sh
npm run test:unit
npm run test:types
npm run build
```

---

## dependency graph

```
step.1 (getExtension) ─────┐
                           ├──► step.3 (getBouncePolicy) ──► step.5 (selectTabsToClose) ──► step.6 (pruneEditors)
step.2 (BouncePolicy) ─────┤                                                                      │
                           └──► step.4 (package.json + getDefaultBounceConfig) ───────────────────┘
                                                                                                   │
step.7 (keystroke tracking) ───────────────────────────────────────────────────────────────────────┤
                                                                                                   │
                                                                                                   ▼
                                                                                       step.8 (full test suite)
```

---

## parallel execution opportunities

- **batch 1** (no deps): step.1, step.2, step.7
- **batch 2** (after batch 1): step.3, step.4
- **batch 3** (after batch 2): step.5
- **batch 4** (after batch 3): step.6
- **batch 5** (after all): step.8

---

## test coverage matrix

| file | test file | coverage |
|------|-----------|----------|
| `getExtension.ts` | `getExtension.test.ts` | extension extraction edge cases |
| `BouncePolicy.ts` | (type-only, verified by tsc) | type safety |
| `getBouncePolicy.ts` | `getBouncePolicy.test.ts` | policy resolution per extension |
| `getDefaultBounceConfig.ts` | `getDefaultBounceConfig.test.ts` | default config values |
| `selectTabsToClose.ts` | `selectTabsToClose.test.ts` | policy-aware closure logic |
| `pruneEditors.ts` | `pruneEditors.test.ts` | config reading + policy application |
| `extension.ts` | `extension.test.ts` | keystroke tracking via onDidChangeTextDocument |
