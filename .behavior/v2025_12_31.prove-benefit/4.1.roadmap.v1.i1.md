# roadmap.v1.i1 = prove-benefit

## overview

checklist roadmap to implement benefit-proving output for bhouncer.
each step has ordered dependencies, acceptance criteria, and verification commands.

---

## phase.1: domain objects

> foundation types for resource tracking

### step.1.1: create ProcessResourceSnapshot

- [ ] create `src/domain.objects/ProcessResourceSnapshot.ts`

**acceptance criteria:**
- file exports `ProcessResourceSnapshot` interface
- interface has: `pid: number`, `memoryBytes: number`, `cpuPercent: number`, `capturedAt: string`

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** nothing

---

### step.1.2: create ServerKillRecord

- [ ] create `src/domain.objects/ServerKillRecord.ts`

**acceptance criteria:**
- file exports `ServerKillRecord` interface
- interface has: `settingKey`, `pid`, `killedAt`, `resourcesBefore`, `memoryFreedBytes`, `cpuFreedPercent`
- `resourcesBefore` typed as `ProcessResourceSnapshot`

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.1.1

---

### step.1.3: modify ExtensionState

- [ ] add `killRecords: ServerKillRecord[]` to `ExtensionState`
- [ ] add `totalMemoryFreedBytes: number` to `ExtensionState`
- [ ] update `createExtensionState()` to initialize new fields

**acceptance criteria:**
- `ExtensionState` interface includes both new fields
- `createExtensionState()` returns `{ ..., killRecords: [], totalMemoryFreedBytes: 0 }`

**verification:**
```sh
npm run test:types
npm run test:unit -- ExtensionState
# expect: no type errors, existing tests pass
```

**depends on:** step.1.2

---

## phase.2: resource measurement

> ability to capture memory/cpu of a process

### step.2.1: create getProcessResources

- [ ] create `src/domain.operations/processes/getProcessResources.ts`
- [ ] implement using `ps -o rss=,pcpu= -p <pid>`
- [ ] return `ProcessResourceSnapshot` on success
- [ ] return `null` if pid not found (ps exits with error)

**acceptance criteria:**
- given valid pid → returns snapshot with memoryBytes > 0
- given invalid pid → returns null (no throw)
- given pid of current process → returns valid snapshot

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.1.1

---

### step.2.2: create getProcessResources unit tests

- [ ] create `src/domain.operations/processes/getProcessResources.test.ts`
- [ ] test: valid pid with mocked ps output → returns parsed snapshot
- [ ] test: ps returns error (pid not found) → returns null
- [ ] test: ps output parsing edge cases (whitespace, decimals)

**acceptance criteria:**
- all unit tests pass
- tests cover: valid pid, invalid pid, parsing edge cases

**verification:**
```sh
npm run test:unit -- getProcessResources.test.ts
# expect: all tests pass
```

**depends on:** step.2.1

---

### step.2.3: create getProcessResources integration tests

- [ ] create `src/domain.operations/processes/getProcessResources.integration.test.ts`
- [ ] test: get resources of current process (process.pid) → returns valid snapshot
- [ ] test: get resources of nonexistent pid → returns null

**acceptance criteria:**
- integration tests pass against real `ps` command
- current process returns memoryBytes > 0 and cpuPercent >= 0

**verification:**
```sh
npm run test:integration -- getProcessResources.integration.test.ts
# expect: all tests pass
```

**depends on:** step.2.2

---

## phase.3: formatting helper

> human-readable memory display

### step.3.1: create formatMemoryBytes

- [ ] create `src/domain.operations/output/formatMemoryBytes.ts`
- [ ] format bytes to KB/MB/GB with 2 decimal places
- [ ] handle edge cases: 0, negative, very large

**acceptance criteria:**
- `1024` → `"1.00 KB"`
- `1048576` → `"1.00 MB"`
- `1073741824` → `"1.00 GB"`
- `0` → `"0 B"`
- `500` → `"500 B"`

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** nothing

---

### step.3.2: create formatMemoryBytes unit tests

- [ ] create `src/domain.operations/output/formatMemoryBytes.test.ts`
- [ ] test: bytes → B formatting
- [ ] test: kilobytes → KB formatting
- [ ] test: megabytes → MB formatting
- [ ] test: gigabytes → GB formatting
- [ ] test: edge cases (0, boundary values)

**acceptance criteria:**
- all unit tests pass
- covers B, KB, MB, GB ranges

**verification:**
```sh
npm run test:unit -- formatMemoryBytes.test.ts
# expect: all tests pass
```

**depends on:** step.3.1

---

## phase.4: benefit-proving disable flow

> ✨ sparkle-labeled output on server kill

### step.4.1: modify disableLanguageServer - capture resources

- [ ] import `getProcessResources` in `disableLanguageServer.ts`
- [ ] call `getProcessResources({ pid })` BEFORE kill
- [ ] store result in `resourcesBefore` variable

**acceptance criteria:**
- resources captured before `killPidSafely` is called
- existing behavior unchanged if resources null

**verification:**
```sh
npm run test:types
npm run test:unit -- disableLanguageServer.test.ts
# expect: no type errors, existing tests still pass
```

**depends on:** step.2.3, step.1.3

---

### step.4.2: modify disableLanguageServer - record kill

- [ ] import `ServerKillRecord` type
- [ ] after successful kill, create `ServerKillRecord`
- [ ] push to `context.state.killRecords`
- [ ] add to `context.state.totalMemoryFreedBytes`

**acceptance criteria:**
- `killRecords` populated after kill
- `totalMemoryFreedBytes` incremented by freed amount

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.4.1

---

### step.4.3: modify disableLanguageServer - sparkle output

- [ ] import `formatMemoryBytes`
- [ ] log `✨ server.killed` with key, pid, memoryFreed, cpuFreed
- [ ] log `✨ resources.freed` with memoryBefore, memoryAfter, memoryDelta, cpuBefore, cpuAfter

**acceptance criteria:**
- output contains `✨ server.killed` message
- output contains `✨ resources.freed` message
- memory displayed in human-readable format (MB, GB)

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.4.2, step.3.2

---

### step.4.4: update disableLanguageServer unit tests

- [ ] add test: server killed with resources → logs ✨ messages
- [ ] add test: server killed without resources (null) → no ✨ messages
- [ ] add test: server already exited → logs already_exited, no ✨ benefit
- [ ] add test: killRecord added to state after kill
- [ ] add test: totalMemoryFreedBytes incremented

**acceptance criteria:**
- all new tests pass
- covers: with resources, without resources, already exited
- verifies ✨ output contains expected fields

**verification:**
```sh
npm run test:unit -- disableLanguageServer.test.ts
# expect: all tests pass (old + new)
```

**depends on:** step.4.3

---

## phase.5: status display

> ✨ aggregate benefit summary in status command

### step.5.1: modify showStatus - benefit summary

- [ ] import `formatMemoryBytes`
- [ ] add `✨ session benefits:` section
- [ ] display `servers killed: N`
- [ ] display `memory freed: X.XX MB`

**acceptance criteria:**
- status shows `✨ session benefits:` header
- shows count of servers killed
- shows total memory freed in human-readable format

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.3.2, step.1.3

---

### step.5.2: modify showStatus - kill history

- [ ] add `✨ kill history:` section
- [ ] list each kill record with timestamp, settingKey, pid, freed amount

**acceptance criteria:**
- status shows `✨ kill history:` header
- each record shown with: timestamp, key, pid, freed memory

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.5.1

---

### step.5.3: update showStatus unit tests

- [ ] add test: no kills → shows `servers killed: 0`, `memory freed: 0 B`
- [ ] add test: one kill → shows correct count and freed amount
- [ ] add test: multiple kills → shows aggregate and full history
- [ ] add test: ✨ emoji present in output

**acceptance criteria:**
- all new tests pass
- covers: zero kills, one kill, multiple kills
- verifies ✨ emoji in output

**verification:**
```sh
npm run test:unit -- showStatus.test.ts
# expect: all tests pass (old + new)
```

**depends on:** step.5.2

---

## phase.6: acceptance tests

> blackbox verification of all criteria

### step.6.1: create acceptance test file

- [ ] create `src/contract/prove-benefit.acceptance.test.ts`
- [ ] setup: mock vscode, create extension state with output capture

**acceptance criteria:**
- test file created
- can capture output log messages for assertions

**verification:**
```sh
npm run test:types
# expect: no type errors
```

**depends on:** step.4.4, step.5.3

---

### step.6.2: test usecase.1 - prove server closure

- [ ] test: last editor closed → output contains ✨ server disabled message
- [ ] test: output contains pid of killed process
- [ ] test: output contains kill result

**acceptance criteria:**
```
given('server running and editors open')
  when('last editor closed')
    then('output contains ✨ sparkle-prefixed disable message')
    then('output contains pid')
    then('output contains kill result')
```

**verification:**
```sh
npm run test:acceptance -- prove-benefit
# expect: usecase.1 tests pass
```

**depends on:** step.6.1

---

### step.6.3: test usecase.2 - prove memory freed

- [ ] test: server killed → output contains memory BEFORE
- [ ] test: output contains memory AFTER (0 B)
- [ ] test: output contains ✨ memory delta

**acceptance criteria:**
```
given('server consuming memory')
  when('server killed')
    then('output contains memoryBefore')
    then('output contains memoryAfter = 0')
    then('output contains ✨ memoryDelta positive')
```

**verification:**
```sh
npm run test:acceptance -- prove-benefit
# expect: usecase.2 tests pass
```

**depends on:** step.6.2

---

### step.6.4: test usecase.3 - prove cpu freed

- [ ] test: server killed → output contains cpu BEFORE
- [ ] test: output contains ✨ cpu now zero

**acceptance criteria:**
```
given('server consuming cpu')
  when('server killed')
    then('output contains cpuBefore')
    then('output contains ✨ cpuAfter = 0%')
```

**verification:**
```sh
npm run test:acceptance -- prove-benefit
# expect: usecase.3 tests pass
```

**depends on:** step.6.3

---

### step.6.5: test usecase.4 - aggregate benefit summary

- [ ] test: show status → displays ✨ total servers killed
- [ ] test: displays ✨ total memory freed
- [ ] test: displays kill history list

**acceptance criteria:**
```
given('one or more servers killed this session')
  when('user invokes show status')
    then('output contains ✨ servers killed count')
    then('output contains ✨ memory freed total')
    then('output contains kill history')
```

**verification:**
```sh
npm run test:acceptance -- prove-benefit
# expect: usecase.4 tests pass
```

**depends on:** step.6.4

---

### step.6.6: test edge cases

- [ ] test edge.1: server already exited → already_exited status, no error
- [ ] test edge.2: no editors open → server disabled with pid
- [ ] test edge.3: output disabled → no output panel messages
- [ ] test edge.4: multiple servers → individual ✨ + total

**acceptance criteria:**
- all edge case tests pass
- graceful handling, no crashes

**verification:**
```sh
npm run test:acceptance -- prove-benefit
# expect: all edge case tests pass
```

**depends on:** step.6.5

---

## phase.7: final verification

> prove all blackbox criteria satisfied

### step.7.1: run full test suite

- [ ] run all tests: unit, integration, acceptance
- [ ] verify no regressions

**acceptance criteria:**
- all tests pass
- no type errors
- no lint errors

**verification:**
```sh
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
npm run test:acceptance
# expect: all pass
```

**depends on:** step.6.6

---

### step.7.2: manual verification

- [ ] build extension: `npm run build`
- [ ] install in vscode: `npm run package && code --install-extension bhouncer-*.vsix`
- [ ] open .tf file → terraform-ls starts
- [ ] close .tf file → verify ✨ output shows memory freed
- [ ] run "Bhouncer: Show Status" → verify ✨ session benefits displayed

**acceptance criteria:**
- ✨ sparkle emojis visible in output panel
- memory freed amount displayed (e.g., "45.2 MB")
- status command shows aggregate benefits

**verification:**
- visual inspection of output panel
- screenshot for documentation

**depends on:** step.7.1

---

## summary checklist

```
phase.1: domain objects
  [ ] step.1.1: create ProcessResourceSnapshot
  [ ] step.1.2: create ServerKillRecord
  [ ] step.1.3: modify ExtensionState

phase.2: resource measurement
  [ ] step.2.1: create getProcessResources
  [ ] step.2.2: create getProcessResources unit tests
  [ ] step.2.3: create getProcessResources integration tests

phase.3: formatting helper
  [ ] step.3.1: create formatMemoryBytes
  [ ] step.3.2: create formatMemoryBytes unit tests

phase.4: benefit-proving disable flow
  [ ] step.4.1: modify disableLanguageServer - capture resources
  [ ] step.4.2: modify disableLanguageServer - record kill
  [ ] step.4.3: modify disableLanguageServer - sparkle output
  [ ] step.4.4: update disableLanguageServer unit tests

phase.5: status display
  [ ] step.5.1: modify showStatus - benefit summary
  [ ] step.5.2: modify showStatus - kill history
  [ ] step.5.3: update showStatus unit tests

phase.6: acceptance tests
  [ ] step.6.1: create acceptance test file
  [ ] step.6.2: test usecase.1 - prove server closure
  [ ] step.6.3: test usecase.2 - prove memory freed
  [ ] step.6.4: test usecase.3 - prove cpu freed
  [ ] step.6.5: test usecase.4 - aggregate benefit summary
  [ ] step.6.6: test edge cases

phase.7: final verification
  [ ] step.7.1: run full test suite
  [ ] step.7.2: manual verification
```

---

## dependency graph

```
step.1.1 ─────────────────┐
                          ▼
step.1.2 ─────────────────┤
                          ▼
step.1.3 ────────────────────────────────┐
                                         │
step.2.1 ← step.1.1                       │
    ▼                                    │
step.2.2                                 │
    ▼                                    │
step.2.3 ────────────────────────────────┤
                                         │
step.3.1                                 │
    ▼                                    │
step.3.2 ────────────────────────────────┤
                                         │
step.4.1 ← step.2.3, step.1.3            │
    ▼                                    │
step.4.2                                 │
    ▼                                    │
step.4.3 ← step.3.2                      │
    ▼                                    │
step.4.4 ────────────────────────────────┤
                                         │
step.5.1 ← step.3.2, step.1.3            │
    ▼                                    │
step.5.2                                 │
    ▼                                    │
step.5.3 ────────────────────────────────┤
                                         │
step.6.1 ← step.4.4, step.5.3            │
    ▼                                    │
step.6.2 → step.6.3 → step.6.4 → step.6.5 → step.6.6
                                              │
                                              ▼
                                         step.7.1
                                              │
                                              ▼
                                         step.7.2
```
