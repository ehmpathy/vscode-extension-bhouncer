# blueprint.v1.i1 = prove-benefit

## summary

add resource measurement and benefit-proving output to bhouncer, enabling users to see ✨ sparkle-labeled proof that language server closures freed memory and cpu.

---

## domain.objects

### new: ProcessResourceSnapshot

```ts
// src/domain.objects/ProcessResourceSnapshot.ts

/**
 * .what = snapshot of a process's resource consumption
 * .why = enables before/after comparison to prove benefit
 */
interface ProcessResourceSnapshot {
  pid: number;
  memoryBytes: number;      // rss in bytes
  cpuPercent: number;       // cpu usage percentage
  capturedAt: string;       // iso timestamp
}
```

### new: ServerKillRecord

```ts
// src/domain.objects/ServerKillRecord.ts

/**
 * .what = record of a server kill with resource proof
 * .why = enables audit trail and aggregate benefit calculation
 */
interface ServerKillRecord {
  settingKey: string;
  pid: number;
  killedAt: string;                           // iso timestamp
  resourcesBefore: ProcessResourceSnapshot;
  memoryFreedBytes: number;
  cpuFreedPercent: number;
}
```

### modify: ExtensionState

add session-level benefit tracking:

```ts
// src/domain.objects/ExtensionState.ts

interface ExtensionState {
  // ... existing fields ...

  /** record of all server kills this session with resource proof */
  killRecords: ServerKillRecord[];

  /** cumulative memory freed this session in bytes */
  totalMemoryFreedBytes: number;
}
```

---

## domain.operations

### new: getProcessResources

```ts
// src/domain.operations/processes/getProcessResources.ts

/**
 * .what = retrieves memory and cpu usage for a pid via ps command
 * .why = enables before-kill resource measurement for benefit proof
 *
 * .note = returns null if pid not found (already exited)
 */
export const getProcessResources = (
  input: { pid: number },
): ProcessResourceSnapshot | null => {
  // use `ps -o rss=,pcpu= -p <pid>` to get memory (kb) and cpu (%)
  // parse output and convert to ProcessResourceSnapshot
  // return null if pid not found
};
```

### new: formatMemoryBytes

```ts
// src/domain.operations/output/formatMemoryBytes.ts

/**
 * .what = formats bytes to human-readable string (KB, MB, GB)
 * .why = enables readable benefit display in output logs
 */
export const formatMemoryBytes = (input: { bytes: number }): string => {
  // e.g., 1048576 -> "1.00 MB"
};
```

### modify: disableLanguageServer

update to capture resources before kill and log ✨ benefit:

```ts
// src/domain.operations/servers/disableLanguageServer.ts

export const disableLanguageServer = async (
  input: { config: LanguageServerConfig },
  context: { state: ExtensionState },
): Promise<void> => {
  const pidBefore = context.state.trackedPids.get(input.config.settingKey) ?? null;

  // capture resources BEFORE kill
  const resourcesBefore = pidBefore
    ? getProcessResources({ pid: pidBefore })
    : null;

  // ... existing disable and kill logic ...

  // log ✨ benefit if resources were captured
  if (resourcesBefore && killResult === 'killed') {
    const memoryFreed = resourcesBefore.memoryBytes;
    const cpuFreed = resourcesBefore.cpuPercent;

    // record for aggregate tracking
    const killRecord: ServerKillRecord = {
      settingKey: input.config.settingKey,
      pid: pidBefore,
      killedAt: new Date().toISOString(),
      resourcesBefore,
      memoryFreedBytes: memoryFreed,
      cpuFreedPercent: cpuFreed,
    };
    context.state.killRecords.push(killRecord);
    context.state.totalMemoryFreedBytes += memoryFreed;

    // ✨ sparkle-labeled benefit output
    context.state.output?.info('✨ server.killed', {
      key: input.config.settingKey,
      pid: pidBefore,
      memoryFreed: formatMemoryBytes({ bytes: memoryFreed }),
      cpuFreed: `${cpuFreed.toFixed(1)}%`,
    });

    context.state.output?.info('✨ resources.freed', {
      memoryBefore: formatMemoryBytes({ bytes: resourcesBefore.memoryBytes }),
      memoryAfter: '0 B',
      memoryDelta: `+${formatMemoryBytes({ bytes: memoryFreed })}`,
      cpuBefore: `${resourcesBefore.cpuPercent.toFixed(1)}%`,
      cpuAfter: '0%',
    });
  }
};
```

### modify: showStatus

update to display ✨ aggregate benefits:

```ts
// src/domain.operations/servers/showStatus.ts

export const showStatus = (context: { state: ExtensionState }): void => {
  // ... existing status lines ...

  // ✨ benefit summary
  const benefitLines = [
    '',
    '✨ session benefits:',
    `  servers killed: ${context.state.killRecords.length}`,
    `  memory freed: ${formatMemoryBytes({ bytes: context.state.totalMemoryFreedBytes })}`,
    '',
    '✨ kill history:',
    ...context.state.killRecords.map(
      (r) => `  ${r.killedAt} | ${r.settingKey} | pid=${r.pid} | freed=${formatMemoryBytes({ bytes: r.memoryFreedBytes })}`,
    ),
  ];

  // append to status display
};
```

---

## test coverage

### unit tests

| file | tests |
|------|-------|
| `getProcessResources.test.ts` | valid pid returns snapshot; invalid pid returns null; parsing edge cases |
| `formatMemoryBytes.test.ts` | bytes -> KB/MB/GB formatting; edge cases (0, negative) |
| `disableLanguageServer.test.ts` | add cases for resource capture and ✨ output |
| `showStatus.test.ts` | add cases for benefit summary display |

### integration tests

| file | tests |
|------|-------|
| `getProcessResources.integration.test.ts` | actually calls ps against real pids (current process) |
| `disableLanguageServer.integration.test.ts` | end-to-end flow with real process spawn/kill and resource measurement |

### acceptance tests

| file | tests |
|------|-------|
| `prove-benefit.acceptance.test.ts` | blackbox test: spawn mock server, close editor, verify ✨ output contains memory/cpu proof |

---

## implementation sequence

### phase.1: domain objects (no tests yet, just types)

1. create `ProcessResourceSnapshot.ts`
2. create `ServerKillRecord.ts`
3. modify `ExtensionState.ts` to add `killRecords` and `totalMemoryFreedBytes`

### phase.2: resource measurement (unit + integration tests)

1. create `getProcessResources.ts`
2. create `getProcessResources.test.ts` - unit tests with mocked execSync
3. create `getProcessResources.integration.test.ts` - real ps calls

### phase.3: formatting helper (unit tests)

1. create `formatMemoryBytes.ts`
2. create `formatMemoryBytes.test.ts`

### phase.4: benefit-proving disable flow (unit tests)

1. modify `disableLanguageServer.ts` to capture resources and log ✨ benefits
2. update `disableLanguageServer.test.ts` with new cases

### phase.5: status display (unit tests)

1. modify `showStatus.ts` to display ✨ aggregate benefits
2. update `showStatus.test.ts` with new cases

### phase.6: acceptance tests (blackbox)

1. create `prove-benefit.acceptance.test.ts`
2. verify all blackbox criteria from `2.criteria.blackbox.md`

---

## files to create

```
src/domain.objects/ProcessResourceSnapshot.ts
src/domain.objects/ServerKillRecord.ts
src/domain.operations/processes/getProcessResources.ts
src/domain.operations/processes/getProcessResources.test.ts
src/domain.operations/processes/getProcessResources.integration.test.ts
src/domain.operations/output/formatMemoryBytes.ts
src/domain.operations/output/formatMemoryBytes.test.ts
src/contract/prove-benefit.acceptance.test.ts
```

## files to modify

```
src/domain.objects/ExtensionState.ts
src/domain.operations/servers/disableLanguageServer.ts
src/domain.operations/servers/disableLanguageServer.test.ts
src/domain.operations/servers/showStatus.ts
src/domain.operations/servers/showStatus.test.ts
```

---

## edge case handling

| edge case | handling |
|-----------|----------|
| pid not found (already exited) | `getProcessResources` returns null; log `already_exited` status, no ✨ benefit line |
| ps command fails | catch error, log warning, proceed without resource snapshot |
| output logging disabled | ✨ logs are no-ops; still track killRecords for status command |
| multiple servers killed | each gets individual ✨ log; aggregate shown in status |

---

## output format examples

### individual kill

```
[2025-12-31T10:00:00.000Z] [INFO] ✨ server.killed {"key":"terraform.languageServer.enable","pid":12345,"memoryFreed":"45.2 MB","cpuFreed":"2.3%"}
[2025-12-31T10:00:00.001Z] [INFO] ✨ resources.freed {"memoryBefore":"45.2 MB","memoryAfter":"0 B","memoryDelta":"+45.2 MB","cpuBefore":"2.3%","cpuAfter":"0%"}
```

### status command

```
bhouncer: enabled
tracked editors: 3
active language servers: 1

tracked pids:
  eslint.enable: 54321

✨ session benefits:
  servers killed: 2
  memory freed: 89.7 MB

✨ kill history:
  2025-12-31T09:45:00.000Z | terraform.languageServer.enable | pid=12345 | freed=45.2 MB
  2025-12-31T09:50:00.000Z | yaml.validate | pid=23456 | freed=44.5 MB
```
