# usecase.1 = prove language server closure on last editor close

given('a user has bhouncer installed and output logging enabled')
  given('a language server is running for a file type (e.g., .tf for terraform-ls)')
  given('one or more editors of that file type are open')

  when('the user closes the last editor of that file type')
    then('the output logs display a ✨ sparkle-prefixed message confirming the server was disabled')
      sothat('user can instantly spot benefit-proving logs via sparkle emoji')
    then('the output logs display the pid of the process that was killed')
      sothat('user can verify which specific process was terminated')
    then('the output logs display the kill result (killed vs already_exited)')
      sothat('user can verify the process was actually running before termination')

  when('all editors of a file type were already closed before bhouncer check runs')
    then('the output logs display that no active server was found to kill')
      sothat('user understands why no termination occurred')


# usecase.2 = prove resource utilization decreased after server closure

given('a user has bhouncer installed and output logging enabled')
  given('a language server is running and consuming resources')

  when('bhouncer disables and kills the language server')
    then('the output logs display the memory usage BEFORE the server was killed')
      sothat('user has a baseline to compare against')
    then('the output logs display the memory usage AFTER the server was killed')
      sothat('user can verify memory was reclaimed')
    then('the output logs display a ✨ sparkle-prefixed memory delta (freed amount)')
      sothat('user instantly spots the benefit in human-readable form')

  when('bhouncer disables a server that used significant memory')
    then('the ✨ memory delta displayed is positive (resources freed)')
      sothat('user receives sparkle-labeled proof of the benefit')


# usecase.3 = prove cpu utilization decreased after server closure

given('a user has bhouncer installed and output logging enabled')
  given('a language server is running and consuming cpu')

  when('bhouncer disables and kills the language server')
    then('the output logs display cpu usage of the process BEFORE termination')
      sothat('user can see what cpu load was being consumed')
    then('the output logs display a ✨ sparkle-prefixed confirmation the cpu load is now zero')
      sothat('user instantly spots that cpu was reclaimed')


# usecase.4 = aggregate benefit summary

given('a user has bhouncer installed and output logging enabled')
  given('bhouncer has killed one or more language servers during the session')

  when('the user invokes "Bhouncer: Show Status" command')
    then('the output displays ✨ total servers killed this session')
      sothat('user sees sparkle-labeled quantitative proof of activity')
    then('the output displays ✨ total memory freed this session')
      sothat('user sees sparkle-labeled cumulative resource benefit')
    then('the output displays list of which servers were killed and when')
      sothat('user has an audit trail of all bouncer activity')


# edge.1 = server not running when last editor closed

given('a user closes the last editor of a file type')
  given('the language server for that file type was already stopped')

  when('bhouncer attempts to disable the server')
    then('the output logs display "already_exited" or "not_tracked" status')
      sothat('user understands no kill was necessary')
    then('no error is displayed')
      sothat('user knows this is expected behavior, not a failure')


# edge.2 = no editors open for a server type

given('a language server is configured for a file type (e.g., .yaml)')
  given('no editors of that file type are currently open')

  when('bhouncer check cycle runs')
    then('the output logs confirm the server should be disabled')
      sothat('user can verify bhouncer logic is correct')
    then('the output logs display the pid targeted for termination')
      sothat('user can verify the correct process is identified')


# edge.3 = output logging disabled

given('a user has bhouncer installed')
  given('output logging is disabled in settings')

  when('bhouncer performs any action')
    then('no output panel messages are created')
      sothat('user who prefers quiet operation is not disturbed')


# edge.4 = multiple servers killed in single cycle

given('a user closes multiple editor types simultaneously')
  given('multiple language servers are running for those file types')

  when('bhouncer check cycle runs')
    then('the output logs display ✨ each server killed separately with its freed resources')
      sothat('user can see sparkle-labeled individual proof for each server')
    then('the output logs display ✨ total resources freed across all servers')
      sothat('user sees sparkle-labeled combined benefit in one glance')
